<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LunchPro — Оформить заказ</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/checkout.css">
  <link rel="stylesheet" href="css/print.css" media="print">
</head>
<body>
  <header>
    <h1>LunchPro</h1>
    <nav>
      <a href="index.html">Главная</a>
      <a href="lunch.html">Собрать ланч</a>
      <a href="checkout.html" class="active">Оформить заказ</a>
      <a href="#">О нас</a>
      <a href="#contacts">Контакты</a>
    </nav>
    <button id="api-key-btn" class="login-btn">API Ключ</button>
  </header>

  <main class="checkout-main">
    <div class="checkout-container">
      <!-- Левая колонка: Состав заказа -->
      <section class="order-composition">
        <div class="section-header">
          <h2><i class="fas fa-shopping-basket"></i> Состав заказа</h2>
        </div>
        
        <div id="checkout-order-summary" class="order-composition-content">
          <div class="empty-order-message">
            <i class="fas fa-shopping-cart"></i>
            <h3>Корзина пуста</h3>
            <p>Чтобы добавить блюда в заказ, перейдите на страницу</p>
            <a href="lunch.html" class="cta-button">
              <i class="fas fa-utensils"></i>
              Собрать ланч
            </a>
          </div>
          
          <!-- Блюда будут добавляться здесь динамически -->
          
          <div class="order-total-card">
            <div class="total-line">
              <span>Итого:</span>
              <span id="composition-total">0 ₽</span>
            </div>
            <div class="total-items">
              <span id="composition-count">0 блюд</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Правая колонка: Оформление заказа -->
      <section class="order-checkout">
        <div class="section-header">
          <h2><i class="fas fa-clipboard-list"></i> Оформление заказа</h2>
        </div>
        
        <div class="checkout-content">
          <form id="checkout-form" class="checkout-form">
            <!-- Остальная часть формы без изменений -->
            <div class="form-section">
              <h3><i class="fas fa-user"></i> Ваши данные</h3>
              <div class="form-grid">
                <div class="form-group">
                  <label for="full_name">ФИО *</label>
                  <input type="text" id="full_name" name="full_name" required>
                </div>
                <div class="form-group">
                  <label for="email">Email *</label>
                  <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                  <label for="phone">Телефон *</label>
                  <input type="tel" id="phone" name="phone" required>
                </div>
              </div>
            </div>

            <div class="form-section">
              <h3><i class="fas fa-truck"></i> Доставка</h3>
              <div class="form-group">
                <label for="address">Адрес доставки *</label>
                <input type="text" id="address" name="address" required placeholder="Улица, дом, квартира">
              </div>
              
              <div class="delivery-time-section">
                <label>Время доставки</label>
                <div class="delivery-options">
                  <div class="delivery-option">
                    <input type="radio" id="asap" name="delivery_type" value="now" checked>
                    <label for="asap">
                      <i class="fas fa-bolt"></i>
                      <span>Как можно скорее</span>
                    </label>
                  </div>
                  <div class="delivery-option">
                    <input type="radio" id="scheduled" name="delivery_type" value="by_time">
                    <label for="scheduled">
                      <i class="fas fa-clock"></i>
                      <span>Ко времени</span>
                    </label>
                  </div>
                </div>
                <input type="time" id="delivery_time" name="delivery_time" min="07:00" max="23:00" disabled>
              </div>
            </div>

            <div class="form-section">
              <h3><i class="fas fa-notes-medical"></i> Дополнительно</h3>
              <div class="form-group">
                <label for="comment">Комментарий к заказу</label>
                <textarea id="comment" name="comment" rows="3" placeholder="Особые пожелания или комментарии..."></textarea>
              </div>
              
              <div class="checkbox-group">
                <input type="checkbox" id="subscribe" name="subscribe">
                <label for="subscribe" class="checkbox-label">
                  <span class="checkmark"></span>
                  Получать информацию о скидках и акциях
                </label>
              </div>
            </div>

            <div class="order-summary-mini">
              <h4><i class="fas fa-receipt"></i> Ваш заказ</h4>
              <div id="order-items-mini" class="order-items-mini">
                <!-- Мини-список заказа -->
              </div>
              <div class="mini-total">
                <strong>К оплате: <span id="mini-total">0</span> </strong>
              </div>
            </div>

            <button type="submit" class="submit-order-btn">
              <i class="fas fa-paper-plane"></i>
              Отправить заказ
            </button>
          </form>
        </div>
      </section>
    </div>
  </main>

  <!-- Модальное окно для API ключа -->
  <div id="api-key-modal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <span id="close-api-modal" class="close" role="button" aria-label="закрыть">&times;</span>
      <div class="api-key-form">
        <h2>Настройка API ключа</h2>
        <div class="api-key-info">
          <div class="info-card">
            <h3><i class="fas fa-key"></i> Как получить API ключ</h3>
            <ol>
              <li>Перейдите по ссылке: <a href="https://edu.std-900.ist.mospolytech.ru/get_api_key" target="_blank" class="api-link">Получить API ключ</a></li>
              <li>Скопируйте ваш уникальный ключ (формат: 123e4567-e89b-12d3-a456-426655440000)</li>
              <li>Вставьте ключ в поле ниже и нажмите "Сохранить"</li>
            </ol>
            <div class="warning">
              <i class="fas fa-exclamation-triangle"></i>
              <strong>Важно:</strong> Никому не сообщайте ваш ключ!
            </div>
          </div>
        </div>
        
        <form id="api-key-form">
          <div class="form-group">
            <label for="api-key-input">Ваш API ключ:</label>
            <input type="text" id="api-key-input" name="api_key" required placeholder="Введите ваш API ключ (формат UUID)">
          </div>
          <button type="submit" class="submit-btn">
            <i class="fas fa-save"></i>
            Сохранить ключ
          </button>
        </form>
        
        <div id="api-status" class="api-status"></div>
      </div>
    </div>
  </div>

  <footer id="contacts">
    <p>Телефон: +7 (123) 456-78-90 | Email: info@lunchpro.ru</p>
    <p>© 2025 LunchPro — Доставка бизнес-ланчей</p>
  </footer>

  <script src="js/api.js"></script>
  <script src="js/validation.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/checkout.js"></script>

  <script>
    // Управление модальным окном API ключа
    const apiModal = document.getElementById('api-key-modal');
    const apiKeyBtn = document.getElementById('api-key-btn');
    const closeApiModal = document.getElementById('close-api-modal');
    const apiKeyForm = document.getElementById('api-key-form');
    const apiKeyInput = document.getElementById('api-key-input');
    const apiStatus = document.getElementById('api-status');

    function openApiModal() {
      apiModal.style.display = 'flex';
      apiModal.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
      
      const savedKey = localStorage.getItem('lunchProApiKey');
      if (savedKey) {
        apiKeyInput.value = savedKey;
      }
    }

    function closeApiModalFunc() {
      apiModal.style.display = 'none';
      apiModal.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
    }

    function showApiStatus(message, isSuccess) {
      apiStatus.style.display = 'block';
      apiStatus.textContent = message;
      apiStatus.className = `api-status ${isSuccess ? 'success' : 'error'}`;
    }

    apiKeyForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const key = apiKeyInput.value.trim();
      
      if (!key) {
        showApiStatus('Пожалуйста, введите API ключ', false);
        return;
      }

      const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
      if (!uuidRegex.test(key)) {
        showApiStatus('Неверный формат ключа. Ключ должен быть в формате UUID.', false);
        return;
      }

      try {
        setApiKey(key);
        await loadDishes();
        showApiStatus('Ключ успешно сохранен и проверен!', true);
        
        setTimeout(() => {
          closeApiModalFunc();
        }, 2000);
      } catch (error) {
        showApiStatus('Ошибка: ' + error.message, false);
      }
    });

    // Время доставки
    const asapRadio = document.getElementById('asap');
    const scheduledRadio = document.getElementById('scheduled');
    const timeInput = document.getElementById('delivery_time');

    function toggleTimeInput() {
      if (asapRadio && scheduledRadio && timeInput) {
        timeInput.disabled = !scheduledRadio.checked;
        timeInput.required = scheduledRadio.checked;
      }
    }

    if (asapRadio && scheduledRadio) {
      asapRadio.addEventListener('change', toggleTimeInput);
      scheduledRadio.addEventListener('change', toggleTimeInput);
      toggleTimeInput();
    }

    apiKeyBtn.addEventListener('click', openApiModal);
    closeApiModal.addEventListener('click', closeApiModalFunc);
    
    window.addEventListener('click', e => { 
      if (e.target === apiModal) closeApiModalFunc(); 
    });
    
    window.addEventListener('keydown', e => { 
      if (e.key === 'Escape' && apiModal.style.display === 'flex') closeApiModalFunc(); 
    });

    // Проверяем наличие API ключа при загрузке
    document.addEventListener('DOMContentLoaded', async function() {
      const savedKey = localStorage.getItem('lunchProApiKey');
      if (!savedKey) {
        setTimeout(openApiModal, 1000);
      }
    });
  </script>
</body>
</html>